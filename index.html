<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>代码计算器</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            font-size: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            width: calc(100% - 2.5rem);
            margin: 0 auto;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 0.125rem 0.625rem rgba(0,0,0,0.1);
            height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }
        
        .expression-line {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.0625rem;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            gap: 0.625rem;
            min-height: 3.5rem;
            position: relative;
            overflow: hidden;
        }

        .expression-line:nth-child(even) {
            background-color: #e9ecef;
        }

        .input {
            flex: 1;
            font-size: 1.5rem;
            font-family: monospace;
            border: none;
            background: transparent;
            outline: none;
            padding: 0;
            min-width: 0;
            color: #212529;
            position: relative;
            z-index: 1;
        }

        .result {
            font-size: 1.5rem;
            font-family: monospace;
            padding-left: 0.625rem;
            border-left: 0.0625rem solid #dee2e6;
            width: 10rem;
            text-align: right;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 0.5rem;
            position: relative;
        }

        /* 等号的基本样式 */
        .result::before {
            content: "=";
            position: absolute;
            left: 0.625rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s, color 0.2s, font-weight 0.2s;
        }

        /* 有输入时显示等号 */
        .result.has-input::before {
            opacity: 1;
            color: #6c757d;  /* 默认使用灰色 */
        }

        /* 有结果时等号使用正常颜色 */
        .result.has-value::before {
            color: inherit;
        }

        /* 警告时等号使用警告颜色 */
        .result.warning::before {
            color: #f0ad4e;  /* 使用原始黄色 */
            font-weight: bold;
        }

        /* 错误时等号使用错误颜色 */
        .result.error::before {
            color: #dc3545;  /* 使用原始红色 */
            font-weight: bold;
        }

        .result-value {
            margin-left: 1.5rem;
            display: inline-block;
        }
        
        .error {
            color: #dc3545;
        }

        #expression-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2.5rem;
            background-color: white;
            box-shadow: 0 -0.125rem 0.625rem rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 1.25rem;
            z-index: 100;
            justify-content: space-between;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip-icon {
            width: 1.5rem;
            height: 1.5rem;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            bottom: 2.8125rem;
            left: 0;
            transform: translateX(0);
            margin-bottom: 0.625rem;
            padding: 0.625rem;
            background-color: #333;
            color: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            box-shadow: 0 0.125rem 0.3125rem rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 101;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 0.75rem;
            margin-left: 0;
            border-width: 0.3125rem;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .clear-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .clear-button:hover {
            background-color: #c82333;
        }

        /* 响应式设计 */
        @media screen and (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                width: calc(100% - 2rem);
                padding: 0.75rem;
            }
            
            .input, .result {
                font-size: 1.2rem;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                font-size: 12px;
                padding: 1vh;
            }
            
            .container {
                width: calc(100% - 1.5rem);
                padding: 0.5rem;
            }
            
            .input, .result {
                font-size: 1rem;
            }
        }

        .result-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 12rem;
            flex-shrink: 0;
            position: relative;
            padding-right: 1.5rem;
        }

        .result {
            font-size: 1.5rem;
            font-family: monospace;
            padding-left: 0.625rem;
            border-left: 0.0625rem solid #dee2e6;
            width: 10rem;
            text-align: right;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 0.5rem;
        }

        .message-icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-weight: bold;
            display: none;
            width: 1.5rem;
            height: 1.5rem;
            text-align: center;
            line-height: 1.5rem;
            background: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expression-line:nth-child(even) .message-icon {
            background-color: #e9ecef;
        }

        .expression-line:nth-child(odd) .message-icon {
            background-color: #f8f9fa;
        }

        .message-icon.error {
            color: #dc3545;
        }

        .message-icon.warning {
            color: #f0ad4e;
        }

        .message-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 100%;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
            margin-right: 8px;
            transition: visibility 0s, opacity 0.2s;
        }

        .message-icon.error .message-text {
            background-color: rgba(220, 53, 69, 0.9);
        }

        .message-icon.warning .message-text {
            background-color: rgba(240, 173, 78, 0.9);
        }

        .message-icon:hover .message-text {
            visibility: visible;
            opacity: 1;
        }

        /* 补全提示的样式 */
        .completion-hint {
            position: absolute;
            color: #adb5bd;
            font-family: monospace;
            font-size: 1.5rem;
            pointer-events: none;
            white-space: pre;
            overflow: hidden;
            background: transparent;
            z-index: 0;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0.75rem 1rem;  /* 与 expression-line 的 padding 一致 */
            display: flex;
            align-items: center;
        }

        /* 消息图标的基本内容 */
        .message-icon::before {
            content: "⚠";  /* 默认是警告图标 */
        }

        /* 错误图标样式 */
        .message-icon.error::before {
            content: "❌";  /* 使用乘号作为错误图标 */
            font-size: 1rem;  /* 调整大小 */
        }

        /* 警告图标保持原样 */
        .message-icon.warning::before {
            content: "⚠";
        }

        /* 成功图标样式 */
        .message-icon.success {
            color: #28a745;  /* 使用绿色 */
        }

        .message-icon.success::before {
            content: "ⓘ";
            font-family: Arial, sans-serif;
            font-size: 1.2rem;
        }

        /* 成功提示文本背景 */
        .message-icon.success .message-text {
            background-color: rgba(40, 167, 69, 0.9);  /* 半透明绿色 */
        }

        /* 修改错误样式，使其更具体 */
        .result.error .result-value {
            color: #dc3545;  /* 红色 */
        }

        /* 移除原来的通用错误样式 */
        .error {
            /* 删除这个样式 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="expression-container">
            <div class="expression-line">
                <input type="text" class="input" placeholder="输入表达式，例如: 2 + 3 * 4" 
                       oninput="handleInput(event)"
                       onkeydown="handleKeyDown(event, this)">
                <div class="result-container">
                    <div class="result">
                        <span class="result-value"></span>
                    </div>
                    <div class="message-icon">
                        <div class="message-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="tooltip">
            <div class="tooltip-icon">?</div>
            <div class="tooltip-text">
                默认常数：<br>
                • PI=3.14159, e=2.71828<br>
                <br>
                基础运算：<br>
                • +, -, *xX, /, //(整除), %(余数), **(幂)<br>
                <br>
                弧度角度转换：<br>
                • 默认使用弧度，后缀+d表示角度<br>
                • 30d=30*pi/180<br>
                <br>
                数学函数：<br>
                • 弧度：sin(PI/6), cos(PI/2), tan(PI/4)<br>
                • 对应角度：sin(30d), cos(90d), tan(45d)<br>
                • log(100), ln(e), exp(2)=e²<br>
                • sqrt(2), root(8,3)=2<br>
                <br>
                进制：<br>
                • 其它进制转十进制：0b111, 0o111, 0x111<br>
                • 十进制转其它进制：bin(111), oct(111), hex(111)<br>
            </div>
        </div>
        <button class="clear-button" onclick="clearAll()">清空</button>
    </div>

    <script src="calculator.js"></script>
    <script>
        // 添加可补全的函数和操作列表
        const completions = [
            'sin(', 'cos(', 'tan(',
            'log(', 'ln(', 'exp(',
            'sqrt(', 'root(',
            'bin(', 'oct(', 'hex(',
            'PI',
            '0b', '0o', '0x'
        ];

        function calculateLine(input) {
            const resultContainer = input.parentElement.querySelector('.result-container');
            const result = resultContainer.querySelector('.result');
            const messageIcon = resultContainer.querySelector('.message-icon');
            const messageText = messageIcon.querySelector('.message-text');
            const expression = input.value.trim();
            
            // 清除所有状态
            function clearState() {
                result.innerHTML = '<span class="result-value"></span>';
                result.classList.remove('has-input', 'has-value', 'warning', 'error', 'success');
                messageIcon.style.display = 'none';
            }

            // 设置状态
            function setState(value, type, message) {
                result.innerHTML = `<span class="result-value">${value}</span>`;
                result.classList.remove('warning', 'error', 'success');  // 先移除所有状态
                result.classList.add('has-value', type);  // 再添加新状态
                messageIcon.className = `message-icon ${type}`;
                messageIcon.style.display = 'inline';
                messageText.textContent = message;
            }

            // 设置正常结果
            function setNormalState(value) {
                result.innerHTML = `<span class="result-value">${value}</span>`;
                result.classList.remove('warning', 'error', 'success');  // 确保移除所有特殊状态
                result.classList.add('has-value');
                messageIcon.style.display = 'none';
            }

            // 空输入处理
            if (expression === '') {
                clearState();
                return;
            }
            result.classList.add('has-input');

            try {
                const value = calculate(expression);
                if (typeof value === 'object') {
                    if (value.warning) {
                        setState(value.value, 'warning', value.warning);
                    } else if (value.success) {
                        setState(value.value, 'success', value.success);
                    }
                } else {
                    setNormalState(value);
                }
            } catch (error) {
                setState('', 'error', error.message);
            }
        }

        function addNewLine() {
            const container = document.getElementById('expression-container');
            const newLine = document.createElement('div');
            newLine.className = 'expression-line';
            newLine.innerHTML = `
                <input type="text" class="input" placeholder="输入表达式" 
                       oninput="handleInput(event)"
                       onkeydown="handleKeyDown(event, this)">
                <div class="result-container">
                    <div class="result">
                        <span class="result-value"></span>
                    </div>
                    <div class="message-icon" style="display: none;">
                        <div class="message-text"></div>
                    </div>
                </div>
            `;
            container.appendChild(newLine);
            newLine.querySelector('.input').focus();
        }

        function handleKeyDown(event, input) {
            const currentLine = input.parentElement;
            
            if (event.key === 'Enter') {
                event.preventDefault(); // 阻止默认的回车行为
                
                const expression = input.value.trim();
                const result = currentLine.querySelector('.result');
                const hasExpression = expression !== '';
                
                // 修改判断逻辑：只要有输入内容就以添加新行
                if (hasExpression) {
                    const lines = document.querySelectorAll('.expression-line');
                    const isLastLine = input === lines[lines.length - 1].querySelector('.input');
                    
                    if (isLastLine) {
                        addNewLine();
                    } else {
                        // 如果不是最后一行，移动焦点到下一行
                        const nextLine = currentLine.nextElementSibling;
                        if (nextLine) {
                            nextLine.querySelector('.input').focus();
                        }
                    }
                }
            } else if (event.key === 'Backspace' && input.value === '') {
                // 当Backspace键且当前输入框空时
                event.preventDefault();
                const previousLine = currentLine.previousElementSibling;
                
                // 如果存在上一行且前不是第一行
                if (previousLine && document.querySelectorAll('.expression-line').length > 1) {
                    // 移焦点到上一行的输入框
                    const previousInput = previousLine.querySelector('.input');
                    previousInput.focus();
                    // 将光标移到文本末尾
                    previousInput.selectionStart = previousInput.value.length;
                    previousInput.selectionEnd = previousInput.value.length;
                    
                    // 如果当前行是空，则删除当前行
                    if (!input.value && !currentLine.querySelector('.result').textContent) {
                        currentLine.remove();
                    }
                }
            } else if (event.key === 'ArrowUp') {
                // 向上键
                event.preventDefault();
                const previousLine = currentLine.previousElementSibling;
                if (previousLine) {
                    const previousInput = previousLine.querySelector('.input');
                    previousInput.focus();
                    // 保持光标位置
                    const cursorPos = input.selectionStart;
                    previousInput.selectionStart = Math.min(cursorPos, previousInput.value.length);
                    previousInput.selectionEnd = Math.min(cursorPos, previousInput.value.length);
                }
            } else if (event.key === 'ArrowDown') {
                // 向下键
                event.preventDefault();
                const nextLine = currentLine.nextElementSibling;
                if (nextLine) {
                    const nextInput = nextLine.querySelector('.input');
                    nextInput.focus();
                    // 保持光标位置
                    const cursorPos = input.selectionStart;
                    nextInput.selectionStart = Math.min(cursorPos, nextInput.value.length);
                    nextInput.selectionEnd = Math.min(cursorPos, nextInput.value.length);
                }
            } else if (event.key === 'Tab') {
                event.preventDefault();
                
                const cursorPos = input.selectionStart;
                const textBeforeCursor = input.value.substring(0, cursorPos);
                
                // 找到最后一个单词
                const lastWord = textBeforeCursor.match(/[a-zA-Z0-9]*$/)[0].toLowerCase();
                
                if (lastWord) {
                    // 找到所有匹配的补全选项
                    const matches = completions.filter(c => 
                        c.toLowerCase().startsWith(lastWord)
                    );
                    
                    if (matches.length > 0) {
                        // 使用第一个匹配项进行补全
                        const completion = matches[0];
                        const beforeWord = textBeforeCursor.slice(0, -lastWord.length);
                        const afterCursor = input.value.substring(cursorPos);
                        
                        // 更新输入值
                        if (completion.endsWith('(')) {
                            // 如果是函数，添加右括号并将光标移动到括号内
                            input.value = beforeWord + completion + ')' + afterCursor;
                            const newCursorPos = beforeWord.length + completion.length;
                            input.setSelectionRange(newCursorPos, newCursorPos);
                        } else {
                            // 对于非函数的补全，正常处理
                            input.value = beforeWord + completion + afterCursor;
                            const newCursorPos = beforeWord.length + completion.length;
                            input.setSelectionRange(newCursorPos, newCursorPos);
                        }
                        
                        // 触发计算
                        calculateLine(input);
                    }
                }
                return;
            }

            // 处理其他按键时清除提示
            removeCompletionHint(input);
        }

        // 添加输入事件处理
        function handleInput(event) {
            const input = event.target;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = input.value.substring(0, cursorPos);
            
            // 找到最后一个单词
            const lastWord = textBeforeCursor.match(/[a-zA-Z0-9]*$/)[0].toLowerCase();
            
            // 移除旧的提示
            removeCompletionHint(input);
            
            if (lastWord) {
                // 找到所有匹配的补全选项
                const matches = completions.filter(c => 
                    c.toLowerCase().startsWith(lastWord)
                );
                
                if (matches.length > 0) {
                    // 显示第一个匹配项作为提示
                    const completion = matches[0];
                    const hint = completion.slice(lastWord.length);
                    if (hint) {
                        showCompletionHint(input, textBeforeCursor + hint);
                    }
                }
            }
            
            // 触发计算
            calculateLine(input);
        }

        function showCompletionHint(input, fullText) {
            const hint = document.createElement('div');
            hint.className = 'completion-hint';
            hint.textContent = fullText;
            input.parentElement.appendChild(hint);
        }

        function removeCompletionHint(input) {
            const hint = input.parentElement.querySelector('.completion-hint');
            if (hint) {
                hint.remove();
            }
        }

        // 初始聚焦到输入框
        document.querySelector('.input').focus();

        function clearAll() {
            const container = document.getElementById('expression-container');
            const firstLine = container.querySelector('.expression-line');
            container.innerHTML = '';
            container.appendChild(firstLine);
            
            const input = firstLine.querySelector('.input');
            const result = firstLine.querySelector('.result');
            const messageIcon = firstLine.querySelector('.message-icon');  // 获取图标元素
            
            // 清空所有状态
            input.value = '';  // 清空输入框的值
            result.innerHTML = '';  // 使用 innerHTML 清空结果，确保子元素也被清除
            result.classList.remove('has-input', 'has-value', 'warning', 'error', 'success');
            messageIcon.style.display = 'none';  // 隐藏图标
            
            input.focus();
        }
    </script>
</body>
</html> 